<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGFC ë² ìŠ¤íŠ¸ ê³¨ íˆ¬í‘œ (ë§í¬í˜•)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* ì…ë ¥í¼ ìŠ¤íƒ€ì¼ */
        .input-box { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .input-box h2 { margin-top: 0; margin-bottom: 15px; color: #1a1a1a; text-align: center; font-size: 22px; }
        .guide-text { font-size: 14px; color: #0c5460; background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #17a2b8; line-height: 1.5; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: #555; }
        input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 15px; transition: 0.2s; }
        input:focus { border-color: #007bff; outline: none; }
        button#addBtn { width: 100%; background-color: #007bff; color: white; padding: 14px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button#addBtn:hover { background-color: #0056b3; }
        button#addBtn:disabled { background-color: #a0c4ff; cursor: wait; }

        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ (ë§í¬í˜•) */
        .link-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; border-left: 5px solid transparent; transition: transform 0.2s; }
        .link-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .link-card.clip { border-left-color: #e74c3c; } /* í´ë¦½ì€ ë¹¨ê°„ì¤„ */
        .link-card.video { border-left-color: #3498db; } /* ì˜ìƒì€ íŒŒë€ì¤„ */

        /* ì œëª©(ë§í¬) ìŠ¤íƒ€ì¼ */
        .video-title { font-size: 18px; font-weight: bold; color: #333; text-decoration: none; line-height: 1.4; display: block; }
        .video-title:hover { color: #007bff; text-decoration: underline; }
        .video-title::after { content: " ğŸ”—"; font-size: 14px; } /* ë§í¬ ì•„ì´ì½˜ */

        /* í•˜ë‹¨ ì •ë³´ (ë“±ë¡ì, ë±ƒì§€, íˆ¬í‘œë²„íŠ¼) */
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .info-group { display: flex; flex-direction: column; gap: 2px; }
        .uploader { font-size: 14px; color: #666; }
        .badge { font-size: 11px; color: white; padding: 2px 6px; border-radius: 4px; width: fit-content; }
        .badge.clip { background-color: #e74c3c; } 
        .badge.video { background-color: #3498db; }

        /* íˆ¬í‘œ ë²„íŠ¼ */
        .vote-btn { background-color: #f1f3f5; color: #333; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 6px; transition: 0.2s; font-size: 14px; }
        .vote-btn:hover { background-color: #e9ecef; }
        .vote-btn.active { background-color: #28a745; color: white; } /* íˆ¬í‘œ ì•ˆí•¨ ìƒíƒœ (ì´ˆë¡) */
        .vote-btn.voted { background-color: #6c757d; color: white; cursor: not-allowed; } /* íˆ¬í‘œ ì™„ë£Œ ìƒíƒœ (íšŒìƒ‰) */
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>

<div class="container">
    <div class="input-box">
        <h2>âš½ GGFC ëª…ì¥ë©´ íˆ¬í‘œì†Œ</h2>
        <div class="guide-text">
            <b>ğŸ’¡ ì•ˆë‚´</b><br>
            ì œëª©ì„ í´ë¦­í•˜ë©´ <b>ìƒˆ ì°½</b>ì—ì„œ ì˜ìƒì´ ì¬ìƒë©ë‹ˆë‹¤.<br>
            ìœ íŠœë¸Œ ê³µìœ  ë§í¬, ì£¼ì†Œì°½ ë§í¬ ëª¨ë‘ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
        
        <div class="form-group">
            <label>1. ë“±ë¡ì ì´ë¦„</label>
            <input type="text" id="userName" placeholder="ì˜ˆ: ì†í¥ë¯¼">
        </div>
        <div class="form-group">
            <label>2. ì˜ìƒ ì œëª© (ë§í¬ ë¬¸êµ¬)</label>
            <input type="text" id="videoTitle" placeholder="ì˜ˆ: ê¸°ê°€ ë§‰íŒ ì¤‘ê±°ë¦¬ ìŠ›!">
        </div>
        <div class="form-group">
            <label>3. ìœ íŠœë¸Œ ì£¼ì†Œ</label>
            <input type="text" id="videoUrl" placeholder="ìœ íŠœë¸Œ ë§í¬ ë¶™ì—¬ë„£ê¸°">
        </div>
        <button id="addBtn" onclick="uploadVideo()">ë“±ë¡í•˜ê¸°</button>
    </div>

    <div id="videoList">
        <p style="text-align: center; color: #888; margin-top: 50px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>

<script>
    // ============================================================
    // âœ… ì‚¬ìš©ì Firebase ì„¤ì •ê°’ ì ìš© ì™„ë£Œ
    // ============================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCgerolBaDkmbN75y1HJpxKrZgBd4q3kvE",
      authDomain: "ggfc-voting.firebaseapp.com",
      projectId: "ggfc-voting",
      storageBucket: "ggfc-voting.firebasestorage.app",
      messagingSenderId: "615904673843",
      appId: "1:615904673843:web:fd20f417aa324820232346"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const collectionName = "ggfc_links_v1"; 

    // ì‹ë³„ì ë° ë¡œì»¬ ì €ì¥ì†Œ
    const getVoterId = () => {
        let id = localStorage.getItem('ggfcVoterId');
        if (!id) { id = 'user_' + Date.now() + Math.random().toString(36).substr(2, 5); localStorage.setItem('ggfcVoterId', id); }
        return id;
    };
    const currentVoterId = getVoterId();
    const getMyVotes = () => JSON.parse(localStorage.getItem('myVotedVideos') || "[]");


    // âœ… [ë§í¬ ìƒì„±ê¸°] URLì„ ë¶„ì„í•´ì„œ 'ì‹œì²­ìš© ë§í¬(Watch URL)'ë¥¼ ë°˜í™˜
    async function getWatchUrl(rawUrl) {
        let url = rawUrl.trim();
        // ë¶ˆí•„ìš”í•œ íŒŒë¼ë¯¸í„° ì œê±°
        if (url.includes('?si=')) url = url.split('?si=')[0];
        if (url.includes('&si=')) url = url.split('&si=')[0];

        try {
            const urlObj = new URL(url);
            const params = new URLSearchParams(urlObj.search);
            const v = params.get('v');
            const clip = params.get('clip');

            // 1. ê¸´ ì£¼ì†Œ (ê°€ì¥ í™•ì‹¤í•¨)
            if (v) {
                if (clip) return { type: 'clip', url: `https://www.youtube.com/watch?v=${v}&clip=${clip}` };
                return { type: 'video', url: `https://www.youtube.com/watch?v=${v}` };
            }
            // 2. youtu.be ì§§ì€ ì£¼ì†Œ
            if (urlObj.hostname === 'youtu.be' && !url.includes('/clip/')) {
                return { type: 'video', url: `https://www.youtube.com/watch?v=${urlObj.pathname.slice(1)}` };
            }

            // 3. ì§§ì€ í´ë¦½ ì£¼ì†Œ (youtube.com/clip/...) -> Noembedë¡œ ì›ë³¸ ì£¼ì†Œ ì°¾ê¸°
            if (url.includes('/clip/')) {
                const response = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(url)}`);
                const data = await response.json();
                if (data.url) {
                    return { type: 'clip', url: data.url }; // noembedê°€ ì°¾ì•„ì¤€ ì›ë³¸ ì£¼ì†Œ ë°˜í™˜
                }
            }
        } catch (e) { console.error(e); }
        return null;
    }


    // ë“±ë¡ í•¨ìˆ˜
    async function uploadVideo() {
        const name = document.getElementById('userName').value.trim();
        const title = document.getElementById('videoTitle').value.trim();
        const url = document.getElementById('videoUrl').value.trim();

        if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if (!title) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if (!url) return alert("ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const btn = document.getElementById('addBtn');
        btn.disabled = true;
        btn.innerText = "ë“±ë¡ ì¤‘...";

        try {
            const data = await getWatchUrl(url); // ì„ë² ë“œ ì£¼ì†Œ ëŒ€ì‹  ì‹œì²­ ì£¼ì†Œ íšë“

            if (!data) {
                alert("âŒ ë§í¬ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                btn.disabled = false; 
                btn.innerText = "ë“±ë¡í•˜ê¸°";
                return;
            }

            // DB ì €ì¥ (ì œëª© title í•„ë“œ ì¶”ê°€ë¨)
            await db.collection(collectionName).add({
                userName: name,
                title: title,       // ì œëª©
                watchUrl: data.url, // í´ë¦­ ì‹œ ì´ë™í•  ì£¼ì†Œ
                type: data.type,
                votes: 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert("âœ… ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('videoTitle').value = '';
            document.getElementById('videoUrl').value = '';

        } catch (error) {
            alert("ì˜¤ë¥˜: " + error.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "ë“±ë¡í•˜ê¸°";
        }
    }


    // íˆ¬í‘œ í•¨ìˆ˜
    function castVote(docId) {
        const videoRef = db.collection(collectionName).doc(docId);
        const voteRef = videoRef.collection("votedBy").doc(currentVoterId);

        db.runTransaction(async (t) => {
            const doc = await t.get(voteRef);
            if (doc.exists) throw "ALREADY_VOTED";
            t.set(voteRef, { time: firebase.firestore.FieldValue.serverTimestamp() });
            t.update(videoRef, { votes: firebase.firestore.FieldValue.increment(1) });
        }).then(() => {
            let votes = getMyVotes();
            if(!votes.includes(docId)) { votes.push(docId); localStorage.setItem('myVotedVideos', JSON.stringify(votes)); }
            // ê°•ì œ UI ì—…ë°ì´íŠ¸ëŠ” onSnapshotì´ ì²˜ë¦¬í•˜ì§€ë§Œ, ë°˜ì‘ì„±ì„ ìœ„í•´ í´ë˜ìŠ¤ ì¶”ê°€
            document.getElementById(`btn-${docId}`).classList.add('voted');
            document.getElementById(`btn-${docId}`).innerHTML = `âœ… ì™„ë£Œ`;
        }).catch((error) => {
            if (error === "ALREADY_VOTED") alert("ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤!");
        });
    }


    // ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
    db.collection(collectionName).orderBy("timestamp", "desc").onSnapshot((snapshot) => {
        const listDiv = document.getElementById('videoList');
        if (snapshot.empty) { listDiv.innerHTML = '<p style="text-align:center;color:#888;margin-top:50px">ë“±ë¡ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }

        const myVotes = getMyVotes();
        let html = "";

        snapshot.forEach((doc) => {
            const d = doc.data();
            const id = doc.id;
            const isVoted = myVotes.includes(id);

            // ìŠ¤íƒ€ì¼ ì„¤ì •
            const cardClass = d.type === 'clip' ? 'link-card clip' : 'link-card video';
            const badgeClass = d.type === 'clip' ? 'badge clip' : 'badge video';
            const badgeText = d.type === 'clip' ? 'âœ‚ï¸ í´ë¦½' : 'ğŸ¥ ì˜ìƒ';
            
            // ë²„íŠ¼ ì„¤ì •
            let btnClass = isVoted ? "vote-btn voted" : "vote-btn active";
            let btnText = isVoted ? "âœ… ì™„ë£Œ" : "ğŸ‘ ì¶”ì²œ";
            let onClick = isVoted ? "" : `onclick="castVote('${id}')"`;

            html += `
                <div class="${cardClass}">
                    <a href="${d.watchUrl}" target="_blank" class="video-title">${d.title}</a>
                    
                    <div class="card-footer">
                        <div class="info-group">
                            <span class="uploader">ë“±ë¡: ${d.userName}</span>
                            <span class="${badgeClass}">${badgeText}</span>
                        </div>
                        <button id="btn-${id}" class="${btnClass}" ${onClick} ${isVoted ? 'disabled' : ''}>
                            ${btnText} <span style="margin-left:5px; background:rgba(0,0,0,0.1); padding:2px 6px; border-radius:10px;">${d.votes}</span>
                        </button>
                    </div>
                </div>
            `;
        });
        listDiv.innerHTML = html;
    });
</script>

</body>
</html>